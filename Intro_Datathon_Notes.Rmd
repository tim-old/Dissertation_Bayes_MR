---
title: "Intro Datathon Notes"
output:
  pdf_document:
    df_print: paged
date: '2022-10-23'
df_print: kable
fig_caption: yes
toc: yes
## bibliography: Intro_Module_Datathon_Refs.bib
link_citations: yes
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(RColorBrewer)
library(ggnewscale)
library(sysfonts)

```



## Getting Started

I organised the first team meeting, and made a contingency plan when two of our course mates did not respond.

During our first meeting, it was agreed that the whole Healthcare utilisation dataset was too large to handle in its entirety. There was a general consensus that many measures in the dataset would have been impacted by the COVID-19 pandemic, and there was a desire to examine data which may reflect this. We decided to focus on a subset of the data regarding inpatient stays in the first instance - length of stay (LoS) and discharge rates. This choice was partly influenced by my own experiences as a hospital doctor - I had seen first hand how inpatient stays had been affected by, for example, new testing requirements before discharge to care facilities, but also by increased funding for care placements to take pressure off acute hospitals. 

We had agreed that we would each look through the LoS and discharge data individually before the next meeting, to try to find potential variables of particular interest. I began by wrangling the data into a "tidy" format to allow further analysis:

```{r Read In and Tidy}

## read in data from healthcare utilisation data set
dc_data_raw <- read.csv("hu_discharges_by_diagnosis.csv")

los_data_raw <- read.csv("hu_los_by_diagnosis.csv")

## Change names to snake case, switch from long to wide format
dc_data_tidy <- dc_data_raw %>% 
  clean_names() %>% 
  pivot_wider(names_from = c(variable, measure),
              values_from = value,
              id_cols = c(year, country))

los_data_tidy <- los_data_raw %>% 
  clean_names() %>% 
  pivot_wider(names_from = c(variable, measure),
              values_from = value,
              id_cols = c(year, country))

## check data-frame dimensions
dim(dc_data_tidy)
dim(los_data_tidy)

```


Looking through the datasets, I noticed that mental health admissions data were included. It occurred to me that the effects of the COVID-19 pandemic on mental health admissions would be more unpredictable than for other hospital types, as rising infection rates would not directly lead to increased psychiatric admissions in the same way as acute hospital admissions. I therefore decided to subset the data to look at mental health admissions

```{r Subset Mental Health}

## checking names to direct subsetting (hashed for ease of reading of report - 312 + 157 names printed otherwise!)
#names(dc_data_tidy)
#names(los_data_tidy)

## subsetting mental health
mh_dc_data <- dc_data_tidy %>% 
  select(year, country, "Mental and behavioural disorders_Number" : "Other Mental and behavioural disorders_Per 100 000 population") %>% 
  clean_names()

mh_los_data <- los_data_tidy %>% 
  select(year, 
         country, 
         "Mental and behavioural disorders_Days" : "Other Mental and behavioural disorders_Days") %>% 
  mutate(country = as_factor(country),
         year = as_factor(year)) %>%
  clean_names()

```


I then produced some exploratory graphs for the mental health data

```{r Exploratory}

## check data subsetting successful
glimpse(mh_dc_data)

glimpse(mh_los_data)

## plot mental health average LoS by year for each country, then average discharge rate by year for each country
mh_los_plot <- mh_los_data %>% 
  filter(year %in% 2016:2021) %>% 
   ggplot() +
   aes(x = year, y = mental_and_behavioural_disorders_days, colour = country) +
   geom_line() +
  ylab("Mental Health Admission Average Length of Stay in Days")

mh_dc_plot <- mh_dc_data %>% 
   ggplot() +
   aes(x = year, y = mental_and_behavioural_disorders_per_100_000_population, colour = country) +
   geom_line()

mh_los_plot

mh_dc_plot

```

The LoS plot in particular highlighted a remarkable outlier, which I then investigated with further plots. First, I plotted only countries with an average length of stay >50 days, to make labelling clearer and to clarify which country was the outlier. Then, I plotted mental health LoS and discharge rates by individual diagnoses, to ensure one condition wasn't disproportionately driving increasing the observed trends:

```{r Investigate LoS Outlier}

## clear outlier noted for los - repeat graph with highest LoS countries:

mh_long_los_plot <- mh_los_data %>% 
   filter(mental_and_behavioural_disorders_days > 50) %>% 
   ggplot() +
   aes(x = year, y = mental_and_behavioural_disorders_days, colour = country) +
   geom_line()


## outlier noted as Korea -> graph Korea only by diagnosis to see underlying trends

kor_los_data <- mh_los_data %>% 
  filter(country == "Korea")

kor_dc_data <- mh_dc_data %>% 
  filter(country == "Korea")

## switch back to long format to plot by diagnosis
kor_los_data_long_format <- kor_los_data %>% 
  pivot_longer(cols = mental_and_behavioural_disorders_days:other_mental_and_behavioural_disorders_days, names_to = "diagnosis",  values_to = "days")

kor_los_plot <-  kor_los_data_long_format %>% 
  filter(year %in% 2016:2021) %>% 
   ggplot() +
   aes(x = year, y = days, colour = diagnosis) +
   geom_line() +
  geom_line(data = filter(kor_los_data_long_format, diagnosis == "mental_and_behavioural_disorders_days", year %in% 2016:2021), size = 3 ) +
  labs(title = "Average Length of Stay by Mental Health Diagnosis in Korea", subtitle = "Thick line is average across all diagnoses")

## Plot discharge rate by diagnosis

kor_dc_rate_long_format <- kor_dc_data %>% 
  select(year, ends_with("_per_100_000_population")) %>% 
  pivot_longer(cols = mental_and_behavioural_disorders_per_100_000_population:other_mental_and_behavioural_disorders_per_100_000_population, names_to = "diagnosis",  values_to = "rate")

kor_dc_rough_plot_rate <-  kor_dc_rate_long_format %>% 
  ggplot() +
  aes(x = year, y = rate, colour = diagnosis) +
  geom_line()

```

I presented some of these data at our second meeting, and suggested that we could explore Korea's inpatient mental health services as a main focus of our presentation. However, the other members did not agree with this plan. However, other team members had also been considering looking at mental health, so this was designated a key variable of interest. Two potentially confounding factors for changes in mental health during the pandemic were substance misuse and loss of income; alcohol use and GDP were also therefore agreed upon as variable to consider alongside mental health LoS data. It was also decided that we would only look back as far as the period 2016 - 2020.

As most of the group were less experienced with R than me, in particular regarding data visualisation, it was agreed that we would split the data wrangling between us, and I would complete the further exploratory visualisations:

```{r Alcohol Wrangling/Mental health update}

## Alcohol data wrangling code written by another group member


## read in alcohol (alcohol) data:
alcohol_data <- read.csv("alcohol_consumption.csv")

## review structure to determine wrangling needs:
glimpse(alcohol_data)

alcohol_data <- read.csv("alcohol_consumption.csv")


# Factorise years and country
alcohol_data_tidy <- alcohol_data %>% 
  mutate(Year = as_factor(Year)) %>% 
  mutate(Country = factor(Country)) %>% 
  filter(Year %in% 2016:2021) %>% 
  arrange(Country, Year) %>% 
  select(Country, Year, Value)


## TO original code
## ## remove duplicate/redundant columns (N.B all Values are average annual alcohol consumption in ## litres per capita aged 15+):
## alcohol_data_tidy <- alcohol_data %>% 
##   select(Country, Year, Value, Flags) %>% 
##   filter(Year %in% 2016:2021)

#glimpse(alcohol_data_tidy)

## my code resumes:

## update length of stay/discharge data with date range, convert year/country data type to factor
mh_los_tidy <- mh_los_data %>% 
  filter(year %in% 2016:2021) %>% 
    mutate(across( .cols =  c(country, year), .fns = as.factor ))


mh_dc_tidy <- mh_dc_data %>% 
  filter(year %in% 2016:2021) %>% 
  mutate(across( .cols =  c(country, year), .fns = as.factor ))



## combine data frames for alcohol and length of stay, then alcohol and discharges
mh_los_alcohol <- full_join(alcohol_data_tidy, mh_los_tidy, by = c(c("Year" = "year"), c("Country" = "country"))) %>% 
  rename("alcohol_consumption" = Value) %>% 
  as_tibble() %>% 
  mutate(across( .cols =  c(Country, Year), .fns = as.factor ))

mh_dc_alcohol <- full_join(alcohol_data_tidy, mh_dc_tidy, by = c(c("Year" = "year"), c("Country" = "country"))) %>% 
  rename("alcohol_consumption" = Value) %>% 
  as_tibble() %>% 
  mutate(across( .cols =  c(Country, Year), .fns = as.factor ))

```
I decided to plot alcohol usage per capita vs mental health average LoS and mental health discharge data, to see if there were any obvious correlations:



```{r Alcohol / Mental Health LoS}


## Plotting alcohol consumption vs mental health average LoS
rough_plot_los_alcohol <- mh_los_alcohol %>% 
  filter(Country != "Korea") %>% 
  group_by(Country) %>% 
  ggplot() +
  aes(x = mental_and_behavioural_disorders_days, y = alcohol_consumption, colour = Year) +
    geom_point() +
  xlab("Average Length of Stay in days - All mental and behavioural disorders") +
  ylab("Average per capita alcohol consumption - litres per year") +
  facet_wrap(~Year) +
  stat_smooth()

## Plotting alcohol consumption vs mental health discharges
rough_plot_dc_alcohol <- mh_dc_alcohol %>% 
  #filter(Country != "Korea") %>% 
  group_by(Country) %>% 
  ggplot() +
  aes(x = mental_and_behavioural_disorders_per_100_000_population, y = alcohol_consumption, colour = Year) +
    geom_point() + 
  facet_wrap(~Year) +
  stat_smooth()

rough_plot_los_alcohol

rough_plot_dc_alcohol


## Plots just trends in alcohol consumption across years by country
rough_plot_alcohol <- alcohol_data_tidy %>% 
  group_by(Country) %>% 
  ggplot() +
  aes(x = Year, 
      y = Value, 
      colour = Country) +
  geom_point() +
  geom_line( aes(group = Country)) +
  ylab(label = "Average per capita alcohol consumption - litres per year" )


rough_plot_alcohol


```

Unfortunately, another group member had difficulty wrangling the GDP data, so i was not able to explore the effects of this. Mental health length of stay did not seem to correlate with alcohol usage. I began to think of what may cause a prolonged length of stay in general, so that I could look back at the available data sets to see if any could give insights into the factors I would independently have thought influenced length of stay. As I did this, I informally kept an eye on Korean data specifically, as I was genuinely intrigued to see if there was an obvious reason for their prolonged average mental health admission.

I reasoned that possible explanations for long LoS include:

-Inappropriate high LoS: poor quality care -> longer stay
    -patients remain sick, so can't discharge
    -patients don't remain sick, but aren't identified as suitable for discharge

-Appropriate high LoS: sicker patients -> take longer to get better on average
    -higher burden of severe disease across population than other countries, or
    -similar burden of severe disease across population, but less sick are not admitted
    
I therefore began looking first for data sets in the OECD repository which may represent some measure of burden of mental illness by country or quality of mental healthcare in each country, and then produced some further exploratory plots:

```{r Mental Health Burden}

## indicators of mental health burden - only available is suicide rate (death by intentional self harm)

deaths_raw <- read.csv("mortality.csv")

## remove other diagnoses, tidy format

ish_deaths_tidy <- deaths_raw %>% 
  filter(Variable == "Intentional self-harm") %>% 
  select(Measure, Country, Year, Value, Flags) %>% 
  pivot_wider(names_from = Measure, values_from = Value) %>%
  clean_names()

## plot standardised suicide mortality by country

rough_plot_ish_deaths <- ish_deaths_tidy %>% 
  group_by(country) %>% 
  filter(year %in% 2016:2020) %>% 
  ggplot() +
  aes(x = year, 
      y = deaths_per_100_000_population_standardised_rates,
      colour = country) +
  geom_line() +
  geom_line(data = filter(ish_deaths_tidy, 
                          country == "Korea", 
                          year %in% 2016:2021), 
            size = 2 ) +
  ylab("Standardised Suicide Rate per 100,000 Population") +
  labs(title = "Suicide Rate by Year", subtitle = "Thick Line is Korea")

rough_plot_ish_deaths

## Korea is main outlier, Lithuania second highest

```

This graph shows Korea has the highest suicide rate in the OECD, suggesting a high burden of mental illness.

```{r Mental health care quality}

## only measures of quality available for mental health are suicide in hospital/shortly after discharge


## read in data set
mh_quality_raw <- read.csv("health_quality_mh.csv")

## tidy data set 
mh_quality_tidy <- mh_quality_raw %>% 
  select(Country, Periods, Indicator, Gender, Value, Value.1, Flags) %>% 
  pivot_wider(names_from = c(Value),
               values_from = Value.1,
               id_cols = c(Periods, Country, Gender, Flags, Indicator)) %>%
  clean_names()
  
## plot of suicide within 30 days of discharge from mental health facilities
rough_plot_mh_quality <- mh_quality_tidy %>% 
  filter(gender == "Total", 
         periods %in% 2016:2021, 
         indicator == "Suicide within 30 days after discharge among patients diagnosed with a mental disorder") %>% 
  group_by(country) %>% 
  ggplot() +
  aes(x = periods, 
      y = lower_confidence_interval, 
      colour = country ) +
  geom_line() +
  #highlights Korea with a thicker line
  geom_line(data = filter(mh_quality_tidy, 
                          country == "Korea", 
                          gender == "Total", 
                          periods %in% 2016:2021, 
                          indicator == "Suicide within 30 days after discharge among patients diagnosed with a mental disorder"), 
            size = 2 ) + 
  labs(title = "Suicide within 30 days after discharge among patients diagnosed with a mental disorder (lower confidence interval)")
  #facet_wrap(~indicator)

rough_plot_mh_quality  
  
```

This graph, although not conclusive, suggested that the quality of treatment in Korean mental health facilities was inadequate. Patients discharged from Korean mental health beds were the second most likely to kill themselves within 30 days of discharge, suggesting that the treatment they received as an inpatient did not work.

I then started looking for data which might be related to poor quality mental health provision. First, I tried to plot mental health spending per country per year, but the available data was too limited to draw conclusions. I next tried to investigate the effect of number of mental health beds per country, but many countries (including Korea) did not list data for mental health beds specifically, only total hospital beds. Finally, I looked at staffing levels per capita for mental health.


```{r Mental Health Spending}

## read in spending data

spend_raw <- read.csv("expenditure_by_disease.csv")

## select only relevant data
mh_spend_tidy <- spend_raw %>% 
  filter(Diagnostic.Category == "Mental and behavioural disorders") %>% 
  select(Country, Unit, Year, Value) %>% 
  pivot_wider(names_from = Unit, values_from = Value) %>% 
  mutate(Year = as_factor(Year)) %>% 
  clean_names()
  
## limited data - not enough for trend line

rough_plot_mh_spend <- mh_spend_tidy %>% 
group_by(country) %>% 
  ggplot() +
  aes(x = year, 
      y = percent_current_expenditure_on_health, 
      colour = country,
      group = country) +
  geom_line() +
  geom_point() +
  labs(title = "Mental Health Spending as Percentage of Total Healthcare Spend each Year")


## combine mental health spending and LoS in single table

mh_los_spend_join <- left_join(mh_spend_tidy, mh_los_data, by = c("country", "year"))

## no data in common -> even in untidy LoS data, only Czech Rep/Netherlands 2011 

```



```{r  Mental Health Beds}
## mental health beds -> turns out, no data for Korea, only total hospital beds are available

beds_raw <- read.csv("hosp_beds_by_function.csv")

beds_tidy <- beds_raw %>% 
  select(Variable, Measure, Country, Year, Value) %>% 
  clean_names()

mh_beds <- beds_tidy %>% 
  filter(variable %in% c("Long-term psychiatric care beds", 
                         "Psychiatric care beds",
                         "Total hospital beds",
                         "Curative psychiatric care beds",
                         "Rehabilitative psychiatric care beds",
                         "Other psychiatric hospital beds")) %>% 
  pivot_wider(names_from = c(measure, variable), values_from = value) %>% 
  mutate(year = (as_factor(year))) %>% 
  clean_names()

## plot total beds by year/country
rough_plot_total_beds <- mh_beds %>% 
  group_by(country) %>% 
  filter(year %in% 2016:2020) %>% 
  ggplot() +
  aes(x = country, 
      y = per_1_000_population_total_hospital_beds,
      fill = year) +
  geom_col(position = "dodge") +
  geom_col(data = filter(mh_beds,
                         country == "Korea",
                         year %in% 2016:2020), 
           colour = "black", 
           position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_fill_brewer(palette = "Blues")

```


```{r Mental Health Doctors}


## data on number of doctors per speciality
drs_raw <- read.csv("physicians_categories.csv")

mh_drs_tidy <- drs_raw %>% 
  select(Variable, 
         Measure, 
         Country, 
         Year, 
         Value, 
         Flags) %>%   
  filter(Variable == "Psychiatrists",
         Year %in% 2016:2020) %>% 
  mutate(Year = (as_factor(Year)),
         Variable = (as_factor(Variable))) %>%
  pivot_wider(names_from = c(Variable, Measure), 
              values_from = Value) %>% 
  clean_names()

## Odd handling of u with umlaut, mutate can't seem to fix and affects subsequent plot labels - gsub() seems to work to replace name
mh_drs_tidy$country <- gsub(pattern = "TÃ¼rkiye", 
                            replacement = "Turkey", 
                            x = mh_drs_tidy$country)

## bar chart - number of psychiatrists per 1000 population
rough_plot_mh_drs <- mh_drs_tidy %>% 
  group_by(country) %>% 
  filter(year %in% 2016:2020) %>% 
  ggplot() +
  aes(x = country, 
      y = psychiatrists_density_per_1_000_population_head_counts,
      fill = year) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_fill_brewer(palette = "Blues") +
  ggnewscale::new_scale_fill() +
  ## highlight Korea in green, hide legend with green squares
  geom_col(data = filter(mh_drs_tidy,
                         country == "Korea",
                         year %in% 2016:2020), 
           aes(x = country,
               y = psychiatrists_density_per_1_000_population_head_counts,
               fill = year), 
           position = "dodge",
           show.legend = FALSE) +
  scale_fill_brewer(palette = "BuGn") +
  guides(colour = guide_legend(override.aes = list(scale_fill_brewer("Blues")))) +
  ## add median for reference
  geom_hline(aes(yintercept = median(mh_drs_tidy$psychiatrists_density_per_1_000_population_head_counts, na.rm = TRUE)),linetype = "dashed")

rough_plot_mh_drs

rough_plot_los_vs_drs <- mh_los_tidy %>% 
  left_join(mh_drs_tidy, by = (c("year", "country"))) %>% 
  filter(year %in% 2016:2020,
         country != "Korea") %>% # & country != "Switzerland") %>% 
  group_by(country) %>% 
  ggplot() +
  aes(y = psychiatrists_density_per_1_000_population_head_counts, 
      x = mental_and_behavioural_disorders_days,
      colour = country) + 
  geom_point() #+
  #geom_smooth() +
  #facet_wrap(~year)

rough_plot_los_vs_drs

```

I noted that Korea had a relatively low number of psychiatrists per 1000 population. I wanted to check the number of mental health nurses etc per capita, but this data was not available by specialty.

When I presented these graphs to my team, I was able to convince them that would likely be a story in looking at mental health provision in Korea. We agreed to pitch our presentation to health commissioners in Korea, with the aim of inspiring some sort of reform in mental health care, e.g. more spending on staffing etc.


As part of the context


```{r Long Term Care Provision}

## long term care staff data:

ltc_staff <- read.csv("ltc_workers.csv")

## extract variables of interest/remove duplicates
ltc_staff_tidy <- ltc_staff %>% 
  filter(Year %in% 2016:2020) %>% 
  select(Variable, 
         Measure, 
         Country, 
         Year, 
         Value, 
         Flags) %>% 
  mutate(Variable = as_factor(Variable),
         Measure = as_factor(Measure),
         Country = as_factor(Country),
         Year = as.integer(Year)) %>% 
  clean_names()
  

## filter to look at users
ltc_counts <- ltc_staff_tidy %>% 
 filter(variable == "Formal LTC workers (FTE)",
        measure == "Total (nurses and personal carers)" | measure == "Per 100 population aged 65 years old and over") %>% 
  pivot_wider(names_from = c(variable, measure), 
              values_from = value) %>% 
  mutate(year = as_factor(year)) %>% 
  clean_names()


rough_plot_ltc_counts <- ltc_counts %>%
   group_by(country, year) %>%
   ggplot() +
   aes(y = formal_ltc_workers_fte_per_100_population_aged_65_years_old_and_over,
       x = country,
       fill = year) +
   geom_col(position = "dodge") +
   geom_hline(yintercept = median(ltc_counts$formal_ltc_workers_fte_per_100_population_aged_65_years_old_and_over))

 rough_plot_ltc_counts
 
## ltc vs los
 
ltc_los <- ltc_counts %>% 
  full_join(mh_los_data)

rough_plot_ltc_los <- ltc_los %>% 
  filter(year %in% 2016:2020) %>%  #,
         #country != "Korea") %>% 
  group_by(country) %>% 
  ggplot() +
  aes(x = formal_ltc_workers_fte_per_100_population_aged_65_years_old_and_over,
      y = mental_and_behavioural_disorders_days) +
  geom_point(aes(colour = country)) #+
  #facet_wrap(~year)
 
rough_plot_ltc_los 


```




After presenting some of the graphs to my team, I convinced them that there was a story to be found in looking at mental health provision in Korea. We assigned jobs to look further into this, and I started getting some of the graphs into a more finalised state for presentation; I started with the length of stay data, which was from our mandatory data set. As part of this process, I also created a script containing RGB and hexadecimal specifications for the University of Edinburgh brand colours, as this fitted with the formatting which our presentation conductor had settled on:

```{r Edinburgh Style}

## load University of Edinburgh brand colours
source(file = "edin_uni_colours.R")

## use Edinburgh font - source sans pro. Uses sysfonts package.
## ref: https://gel.ed.ac.uk/foundations/typography/
font_add_google("Source Sans Pro")
font_add_google("Crimson Pro")

## make colour palettes from University of Edinburgh colour groups

## Starter palette functions:


## from bright colours
edin_bright_pal <- colorRampPalette(edin_bright_cols_rgb)

## from muted colours
edin_muted_pal <- colorRampPalette(edin_muted_cols_rgb)

## from digital colours
edin_dig_pal <- colorRampPalette(edin_dig_cols_rgb)

## palette from white to uni blue
edin_white_blue_pal <- colorRampPalette(c(#"white",
                                          edin_light_blue_rgb,
                                          #edin_muted_turquoise_rgb,
                                          edin_bright_blue_rgb,
                                          edin_blue_rgb,
                                          #edin_bright_blue_2_rgb,
                                          edin_muted_blue_rgb,
                                          edin_uni_blue_rgb
                                          ))

## palette from white to bright pink
edin_pink_pal <- colorRampPalette(c(edin_muted_pink_rgb,
                                    edin_bright_pink_rgb,
                                    edin_uni_red_rgb,
                                    #edin_bright_red_rgb,
                                    edin_burgundy_rgb,
                                    edin_purple_rgb))


## Palettes for specific plotting tasks

## colour per country
countries_pal <- edin_white_blue_pal(length(unique(mh_los_data$country)))
## used as:
#scale_colour_manual(values = countries_pal) +


## test with:
## colour_test <- edin_muted_pal(50)
## barplot(rep(1, length(colour_test)), names.arg = colour_test, col = colour_test)

```



```{r Presentation Plot LoS, warning=FALSE}

## create data frame of LoS for all countries except Korea for ease of plotting
mh_los_kor_rm <- mh_los_data %>% 
  filter(country != "Korea")

## Data frame sorting non-Korea countries by length of stay in 2020
mh_los_2020_sort <- mh_los_kor_rm %>% 
  filter(year == 2020) %>% 
  arrange(desc(mental_and_behavioural_disorders_days)) 


## main length of stay plot
presentation_plot_mh_los <- mh_los_data %>% 
  filter(year %in% 2016:2020) %>%
  group_by(country) %>% 
   ggplot() +
   aes(x = year, 
       y = mental_and_behavioural_disorders_days) +
  ## plot non-Korea countries - highest and lowest length of stay in 2020 only
  geom_line(data = mh_los_kor_rm %>% 
              filter(year %in% 2016:2020,
                    ## select only countries with the highest and lowest length of stay in 2020 (outside of Korea)
                    country == pull(mh_los_2020_sort, 
                                    country)[1] |
                    country == pull(mh_los_2020_sort, 
                                    country)[max(length(mh_los_2020_sort$country))]),
            aes(colour = country),
            show.legend = FALSE,
            linetype = "solid", 
            size = 1.2) + 
  ## set custom/Edinburgh colours for non-highlighted, comparison lines
  scale_colour_manual(name = "Countries",
                      values = c(edin_bright_blue_rgb, 
                                 edin_muted_blue_rgb)) +
  ## label lines with relevant country names in same colour as line
  annotate(geom = "text", 
           x = 2019.7, 
           y = 70,
           label = "Spain",
           colour = edin_muted_blue_rgb,
           family = "Source Sans Pro", 
           size = 7) +
  annotate(geom = "text", 
           x = 2019.7, 
           y = 20,
           label = "Belgium",
           colour = edin_bright_blue_rgb,
           family = "Source Sans Pro",
           size = 7) +
  ## clear previous colour scale specification to allow custom colours for lines plotted below
  ggnewscale::new_scale_colour() +
  geom_line(data = filter(mh_los_data,
                         country == "Korea",
                         year %in% 2016:2020),
            aes(colour = country),
            size = 1.5,
            show.legend = FALSE) +
  ## set colour of Korea line to pink to highlight
  scale_colour_manual(values = edin_bright_pink_rgb) +
  annotate(geom = "text", 
           x = 2019.7, 
           y = 210,
           label = "Korea",
           colour = edin_bright_pink_rgb,
           family = "Source Sans Pro",
           size = 7) +
  ## set generic theme
  theme_bw() +
  ## label axes with neater names
  ylab("Mental Health Admission Average Length of Stay in Days") +
  xlab("Year") +
  ## change font to University of Edinburgh brand font, source sans pro. \n introduces line break
  labs(family = "Source Sans Pro",
       title = "Korea's average mental health admission is almost four times longer \nthan the next highest average length of stay",
       subtitle = "Spain has the second longest average mental health admission in the OECD, Belgium has the shortest \n",
       caption = "Source: Organisation for Economic Co-operation and Development \nhttps://stats.oecd.org/Index.aspx?DataSetCode=HEALTH_REAC") +
  ## set title and axis colours/font
  theme(title = element_text(family = "Source Sans Pro",
                             colour = edin_spruce_grey_rgb,
                             size = 20),
        plot.subtitle = element_text(family = "Source Sans Pro",
                             colour = edin_spruce_grey_rgb,
                             size = 16),
        plot.caption = element_text(family = "Source Sans Pro",
                                    face = "italic",
                                    colour = edin_spruce_grey_rgb,
                                    size = 7),
        axis.title = element_text(family = "Source Sans Pro",
                                  colour = edin_spruce_grey_rgb,
                                  size = 15),
        axis.text = element_text(family = "Source Sans Pro",
                                 colour = edin_spruce_grey_rgb,
                                 size = 13),
        axis.line = element_line(colour = edin_spruce_grey_rgb,
                                 size = 1), 
        panel.grid = element_line(colour = edin_light_blue_rgb))

#https://albert-rapp.de/posts/ggplot2-tips/07_four_ways_colors_more_efficiently/07_four_ways_colors_more_efficiently.html

presentation_plot_mh_los

```


```{r Presentation Plot Mental Health Doctors, warning=FALSE}

## bar chart - number of psychiatrists per 1000 population
presentation_plot_mh_drs <- mh_drs_tidy %>% 
  group_by(country) %>% 
  filter(year %in% 2016:2020) %>% 
  ggplot() +
  # orientation flipped vs rough plot - allows easier reading of country names
  aes(y = country, 
      x = psychiatrists_density_per_1_000_population_head_counts,
      fill = year) +
  geom_col(position = "dodge") +
  scale_y_discrete(limits = rev) +
  # colour all non-Korea countries in blues
  scale_fill_manual(name = "Year",
                    values = edin_white_blue_pal(
                      #splits palette into same number of colours as max possible number of years to be plotted - allows colour interpolation if more years than colours
                      (length(unique(mh_drs_tidy$year)))),
                    guide = guide_legend(reverse = TRUE)) +
  ggnewscale::new_scale_fill() +
  # highlight Korea in pink/red
  geom_col(data = filter(mh_drs_tidy,
                         country == "Korea",
                         year %in% 2016:2020),
           aes(y = country,
               x = psychiatrists_density_per_1_000_population_head_counts,
               fill = year),
           position = "dodge",
           show.legend = FALSE) +
  scale_fill_manual(values = edin_pink_pal(
    #splits palette into same number of colours as max possible number of years to be plotted - allows colour interpolation if more years than colours
    (length(unique(mh_drs_tidy$year))))
    ) +
  ## add median for reference
  geom_vline(aes(xintercept = median(mh_drs_tidy$psychiatrists_density_per_1_000_population_head_counts, na.rm = TRUE)),
             linetype = "dashed",
             colour = edin_bright_orange_rgb,
             size = 1
             ) +
  annotate(geom = "text", 
           x = 0.193, 
           y = "Colombia",
           label = "Median",
           size = 5,
           colour = edin_bright_orange_rgb) +
  xlab("Psychiatrists per 1,000 Population") +
  ylab( "Country") +
  ## change font to University of Edinburgh brand font, source sans pro. \n introduces line break
  labs(family = "Source Sans Pro",
       title = "Korea has substantially fewer psychiatrists per capita than the OECD median",
       subtitle = "This number has not risen for the past four years \n",
       caption = "Source: Organisation for Economic Co-operation and Development \nhttps://stats.oecd.org/Index.aspx?DataSetCode=HEALTH_REAC") +
  theme_bw() +
  ## set title and axis colours/font
  theme(title = element_text(family = "Source Sans Pro",
                             colour = edin_spruce_grey_rgb,
                             size = 20),
        plot.subtitle = element_text(family = "Source Sans Pro",
                             colour = edin_spruce_grey_rgb,
                             size = 16),
        legend.title = element_text(family = "Source Sans Pro",
                                  colour = edin_spruce_grey_rgb,
                                  size = 15),
        plot.caption = element_text(family = "Source Sans Pro",
                                    face = "italic",
                                    colour = edin_spruce_grey_rgb,
                                    size = 7),
        axis.title = element_text(family = "Source Sans Pro",
                                  colour = edin_spruce_grey_rgb,
                                  size = 15),
        axis.text = element_text(family = "Source Sans Pro",
                                 colour = edin_spruce_grey_rgb,
                                 size = 13),
        axis.line = element_line(colour = edin_spruce_grey_rgb,
                                 size = 1), 
        panel.grid = element_line(colour = edin_light_blue_rgb))

presentation_plot_mh_drs

```



```{r Presentation Plot Long Term Care, warning=FALSE}

presentation_plot_ltc_counts <- ltc_counts %>%
  group_by(country, year) %>%
  # country factors levels start in nonsensical order - reorders alphabetically
  mutate(country = fct_relevel(country,
                               sort(as.character(unique(ltc_counts$country))))
         ) %>% 
  ggplot() +
  aes(x = formal_ltc_workers_fte_per_100_population_aged_65_years_old_and_over,
       y = country,
       fill = year) +
  geom_col(position = "dodge") +
  # flip y axis albel so alphabetical top to bottom rather than bottom to top
  scale_y_discrete(limits = rev) +
  # colour all non-Korea countries in blues
   scale_fill_manual(name = "Year",
                    values = edin_white_blue_pal(
                      #splits palette into same number of colours as max possible number of years to be plotted - allows colour interpolation if more years than colours
                      (length(unique(ltc_counts$year)))),
                    guide = guide_legend(reverse = TRUE)) +
  ggnewscale::new_scale_fill() +
  # highlight Korea in pink/red
  geom_col(data = filter(ltc_counts,
                         country == "Korea",
                         year %in% 2016:2020),
           aes(y = country,
               x = formal_ltc_workers_fte_per_100_population_aged_65_years_old_and_over,
               fill = year),
           position = "dodge",
           show.legend = FALSE) +
  scale_fill_manual(values = edin_pink_pal(
    #splits palette into same number of colours as max possible number of years to be plotted - allows colour interpolation if more years than colours
    (length(unique(ltc_counts$year))))
    ) +
  ## add median for reference
  geom_vline(aes(xintercept = median(ltc_counts$formal_ltc_workers_fte_per_100_population_aged_65_years_old_and_over, 
                                     na.rm = TRUE)),
             linetype = "dashed",
             colour = edin_bright_orange_rgb,
             size = 1
             ) +
  annotate(geom = "text", 
           x = 4.5, 
           y = "Ireland",
           label = "Median",
           size = 5,
           vjust = 0,
           colour = edin_bright_orange_rgb) +
  xlab("Long Term Care Workers per 100 Population Aged 65 and Over") +
  ylab( "Country") +
  ## change font to University of Edinburgh brand font, source sans pro. \n introduces line break
  labs(family = "Source Sans Pro",
       title = "Korea has substantially fewer community care workers per capita \nthan the OECD median",
       subtitle = "This number has risen over the past four years \n",
       caption = "Source: Organisation for Economic Co-operation and Development \nhttps://stats.oecd.org/Index.aspx?DataSetCode=HEALTH_REAC") +
  theme_bw() +
  ## set title and axis colours/font
  theme(title = element_text(family = "Source Sans Pro",
                             colour = edin_spruce_grey_rgb,
                             size = 20),
        plot.subtitle = element_text(family = "Source Sans Pro",
                             colour = edin_spruce_grey_rgb,
                             size = 16),
        legend.title = element_text(family = "Source Sans Pro",
                                  colour = edin_spruce_grey_rgb,
                                  size = 15),
        plot.caption = element_text(family = "Source Sans Pro",
                                    face = "italic",
                                    colour = edin_spruce_grey_rgb,
                                    size = 7),
        axis.title = element_text(family = "Source Sans Pro",
                                  colour = edin_spruce_grey_rgb,
                                  size = 15),
        axis.text = element_text(family = "Source Sans Pro",
                                 colour = edin_spruce_grey_rgb,
                                 size = 13),
        axis.line = element_line(colour = edin_spruce_grey_rgb,
                                 size = 1), 
        panel.grid = element_line(colour = edin_light_blue_rgb))

presentation_plot_ltc_counts

```



```{r}

```

