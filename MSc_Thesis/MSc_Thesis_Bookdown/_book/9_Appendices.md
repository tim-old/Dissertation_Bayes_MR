# (APPENDIX) Appendix {-} 

\newpage


# Appendix: List of Abbreviations {#appendix-acr}


\printacronyms


\newpage

# Appendix: Bootstrapping {#appendix-boot}

## Bootstrapping - General Method

The typical process for "bootstrap" generating an estimate, \acr{SE} and \acr{CI}s of a population parameter (e.g. population mean $\mu$) from a sample $x$ is as follows[@buscaglia_chapter_2020]:

1. A sample, $x$, of $n$ individuals is selected from a total population, $X$, of $N$ individuals
2. This sample $x$ is then treated as the "bootstrap population"; the empirical distribution of values in the $n$ individuals in the bootstrap population is taken to be broadly representative of the distribution of values in the underlying population $X$ of $N$ individuals
3. A "bootstrap sample", $x^*$,  is then obtained by re-sampling individuals from the bootstrap population with replacement $n$ times per bootstrap sample, i.e. the new bootstrap sample comprises $n$ sampled individuals, $x^*_1, x^*_2,...x^*_n$. As such, individuals from the original bootstrap population $x$ may contribute once, more than once or not at all to each bootstrap sample $x^*$.
4. A total of $k$ bootstrap samples are generated, $x^{*1}, x^{*2},...x^{*k}$, and the statistic of interest (e.g. sample mean $\bar{x}$) is estimated in each individual sample, $\bar{x}^{*i}$, giving the complete set of $\bar{x}^{*1}, \bar{x}^{*2},...\bar{x}^{*i}...\bar{x}^{*k}$.
5. The set of $k$ statistics are combined to form a "bootstrap distribution"; as expected from \acr{CLT}[@ross_chapter_2014], this is typically closer to a normal distribution than the underlying distribution of values in either the bootstrap population $x$ or the total population $X$. (See Figure \@ref(fig:prostate-vol) for an example of this)
6. The final values are derived as follows:

> - the parameter estimate (e.g. estimate of the true population mean, $\hat{\mu}$) is taken as the mean of the bootstrap distribution of $k$ estimates, $(\sum^k_{i = 1} \bar{x}) \div n$
> - the \acr{CI}s are taken as the values at the appropriate centiles at the edges of the sampling distribution, e.g. a 95% \acr{CI} would be generated using values at the 2.5th and 97.5th centiles
> - the \acr{SE} of the estimate is taken as the \acr{SD} of the sampling distribution, given by $\sqrt{\frac{1}{k - 1} \sum^k_{i = 1} (\bar{x_i} - \hat{\mu})^2}$



## Bootstrapping - Example: Prostate Volume

The above process is illustrated in \@ref(fig:prostate-vol). Data on prostate volume in 307 prostate cancer patients demonstrates a right-skewed distribution (A). An empirical distribution from a sample of 100 of these patients mirrors this right skew, and is used as the "bootstrap population" (B) for further re-sampling. As the bootstrap population is re-sampled more and more times, the "bootstrap distribution" of the sample means generated (C and D) gradually tends towards a normal distribution. The 95% \acr{CI} is given by the bounds defining the middle 95% of the bootstrap distribution of estimated means, as shown.

![(\#fig:prostate-vol)Histograms demonstrating distribution of prostate volumes in patients with prostatic cancer, taken from Cata et al 2011[@cata_blood_2011] via the R package `medicaldata`[@medicaldata]. A) Distribution from whole study population of 307 patients with non-missing data, exhibiting right-skew. B) Distribution from random sample of 100 patients, still exhibiting right-skew. C) Bootstrap distribution generated by re-sampling 1,000 bootstrap samples from the original sample of 100 patients, right-skew less apparent. D) Bootstrap distribution generated by re-sampling 100,000 bootstrap samples from the original sample of 100 patients, approaching normality. 95% confidence intervals are demonstrated in plots C and D by marking the 2.5th and 97.5th centiles.](9_Appendices_files/figure-latex/prostate-vol-1.png) 

\newpage

## Bootstrapping - Relevance to WME

In current implementations of \acr{WME}, the \acr{WME} estimate of the causal effect ($\hat{\beta}_{WME}$) is calculated as described in Bowden et al[@bowden_consistent_2016], and the 95% \acr{CI} is generated separately using bootstrapping, though notably not using the method described above. 

The bootstrapping process begins similarly, with re-sampling undertaken (a default of $k = 1000$ times) to generate $k$ bootstrap samples $x^{*1}, x^{*2},...x^{*k}$. Each individual bootstrap sample $x^{*i}$ is used to estimate the causal effect using the \acr{WME} method $\hat{\beta}^{*i}_{WME}$, and thus a bootstrap distribution of $k$ values of \acr{WME} is created, $\hat{\beta}^{*1}_{WME},  \hat{\beta}^{*2}_{WME}....\hat{\beta}^{*k}_{WME}$. 

At this stage, however, the bootstrap distribution is then assumed to be approximately normally distributed without verifying this assumption. The 95% \acr{CI} of the bootstrap estimate is then calculated as 1.96 \acr{SD}s of the bootstrap distribution either side of the mean estimate, i.e. $\hat{\beta}_{WME} \pm 1.96  \times SE$. This approach may be problematic for several reasons. 

Although \acr{CLT} leads us to expect that the bootstrap distribution will approach normality as the number of bootstrap iterations $k$ increases, the extent to which this occurs for a given $k$ may depend on the inital distribution of values in the population $X$, and so also on the distribution in the sample/bootstrap population $x$. If the true distribution of values is very non-normal, as may be the case for traits determined by complex genetic and environmental influences, it may take relatively more bootstrap iterations for the bootstrap distribution to become sufficiently normal to assume mean and \acr{SD} accurately describe it. 

Additionally, the bootstrap \acr{SE} is inversely proportional to the number of bootstrap iterations $k$, as opposed to the usual standard error (given by $SE = \frac{SD}{\sqrt{n}}$), which is inversely proportional to the square root of the sample size $n$. It is therefore possible to generate smaller \acr{SE}s by increasing the number of bootstrap samples obtained. This may lead to false confidence in estimates generated despite potential issues with initial sample $x$, e.g. if it too small, or sampled in such a way that it is not representative of the underlying population $X$. Although such issues are inherent to any bootstrapping approaches, the usual method of generating bootstrapped \acr{CI}s detailed above uses more information (i.e. using the entire bootstrap distribution) to generate these values than the parameter-based $estimate \pm 1.96 \times SE$ method (i.e. using approximate summary statistics to represent the distribution). The usual method of bootstrap \acr{CI} generation may therefore be expected to highlight any variation or uncertainty present more readily than the parameter-based approach; this would be represented as wider \acr{CI}s.

\newpage

# Appendix: Simulation Code {#appendix-sim}


## Generating Data and Models {#appendix-sim-gen}

The data generating model used was from Appendix 3 of Bowden et al [@bowden_consistent_2016]; the relevant section describing their model is reproduced below:

>_"..._

>\begin{equation} 
U_i = \sum^J_{j=1} \phi_jG_{ij} + \epsilon_i^U
\end{equation}


>\begin{equation} 
X_i = \sum^J_{j=1} \gamma_jG_{ij} + U_i + \epsilon_i^X
\end{equation}

>\begin{equation} 
Y_i = \sum^J_{j=1} \alpha_jG_{ij} + \beta X_i + U_i + \epsilon_i^Y
\end{equation}

>_for participants indexed by $i = 1, . . . , N$, and genetic instruments indexed by $j = 1, . . . , J$._

>_The error terms $\epsilon_i^U , \epsilon_i^X$ and $\epsilon_i^Y$ were each drawn independently from standard normal distributions. The genetic effects on the exposure γj are drawn from a uniform distribution between 0.03 and 0.1. Pleiotropic effects $\alpha_j$ and $\phi_j$ were set to zero if the genetic instrument was a valid instrumental variable. Otherwise (with probability 0.1, 0.2, or 0.3):_

>_1. In Scenario 1 (balanced pleiotropy, InSIDE satisfied), the $\alpha_j$ parameter was drawn from a uniform distribution between −0.2 and 0.2._

>_2. In Scenario 2 (directional pleiotropy, InSIDE satisfied), the $\alpha_j$ parameter was drawn from a uniform distribution between 0 and 0.2._ 

>_3. In Scenario 3 (directional pleiotropy, InSIDE not satisfied), the $\phi_j$ parameter was drawn from a uniform distribution between −0.2 and 0.2._


>_The causal effect of the exposure on the outcome was either $\beta X = 0$ (null causal effect) or $\beta X = 0.1$ (positive causal effect). A total of 10 000 simulated datasets were generated for sample sizes of N = 10 000 and 20 [sic] participants. Only the summary data, that is genetic associations with the exposure and with the outcome and their standard errors as estimated by univariate regression on the genetic instruments in turn, were used by the analysis methods. In the two-sample setting, data were generated on 2N participants, and genetic associations with the exposure were estimated in the first N participants, and genetic associations with the outcome in the second N participants."_ [@bowden_consistent_2016]

To reproduce this model, code was written in R to generate the relevant participant level data. First, a function (`get_simulated_MR_data`) was written which included parameters specified by Bowden et al, and also to allow testing of data simulation:





This initial simulation function generated data in the following format:




A function (`get_models`) was then written to create linear models from each dataset generated as per Bowden et al:





These models generated estimates of the coefficient of gene-exposure association (`coeff_G_X`), coefficient of gene-outcome association (`coeff_G_Y`), and the relevant standard errors of these estimates. The values of parameters inputted were also returned to aid in further testing of data/model generation, i.e. actual gene-exposure associations (`gamma`), pleiotropic effects of invalid instruments (`alpha`), additional pleiotropic effects when \acr{InSIDE} assumption not satified (`phi`), causal effect of exposure on outcome (`beta`) and the proportion of invalid genetic instruments with pleiotropic effects on the outcome (`prop_invalid`).




\newpage
## Testing Generation of Data and Models {#appendix-sim-test}

A series of test plots were used to verify that data were simulated as intended under the various conditions specified by input parameters. Test plots were not created for the parameters `n_participants`, `n_instruments` or `n_datasets`, as the functioning of these parameters could be readily inferred from the structure of the  datasets outputted, as above.

### Proportion of Invalid Instruments
\leavevmode\newline The `prop_invalid` parameter specifies the proportion of invalid genetic instruments simulated, i.e. the proportion of genetic instruments affecting the outcome via direct/pleiotropic effects, and thus not solely via the exposure of interest. If simulated correctly, increasing the value of `prop_invalid` should increase the number of instruments with pleiotropic effects, i.e. instruments with `alpha` $\ne$ 0. With random error terms set to 0 and no causal effect present (i.e. `rand_error = FALSE` and `causal_effect = FALSE`), the estimated gene-outcome coefficient estimated using any given instrument will equal the pleiotropic effects of that instrument (i.e. `coeff_G_Y = alpha`), and therefore will only be non-zero for invalid instruments with non-zero pleiotropic effects on the outcome . Plotting `coeff_G_Y` against `alpha` for simulated data with no causal effect or random error should therefore yield a graph where

- For valid instruments: gene-outcome coefficient = alpha = 0
- For invalid instruments:  gene-outcome coefficient = alpha $\ne$  0, with values spread uniformly between `alpha_min` and `alpha_max`




\newpage
Similarly, with random error terms set to 0 (`rand_error = FALSE`) and no causal effect present (`causal_effect = FALSE`), gene-exposure coefficients estimated for each instrument should exactly match the actual values simulated, i.e. `coeff_G_X = gamma` for all instruments:



\newpage
### Gene-Exposure Coefficient Versus Gene-Outcome Coefficient Plots
\leavevmode\newline For the next phase of testing, a function (`plot_GY_GX`) was written to plot the coefficients for gene-exposure versus gene-outcome as estimated using the previously created linear models:



\newpage
With random error terms set to 0 (`rand_error = FALSE`) and no causal effect present, a graph of gene-exposure coefficients versus gene-outcome coefficients should be a straight line through the origin with gradient = 0; causal effect of $\beta$ = 0.1  present (`beta_val = 0.1`, `causal_effect = TRUE`), the slope of a graph of gene-exposure coefficients versus gene-outcome coefficients from the same sample should be a straight line through the origin with gradient = 0.1:




\newpage
### Random Errors
\leavevmode\newline Re-plotting the same graphs with non-zero random error terms (`rand_error = TRUE`) should produce similar graphs with Gaussian spread around lines passing through the origin with gradients of 0 and 0.1 for no causal effect and causal effect, respectively:



\newpage
### One versus Two Sample MR
\leavevmode\newline Where gene-exposure coefficients and gene-outcome coefficients are estimated from two separate samples rather than one (i.e. `two_sample = TRUE`, simulating 2 sample MR), even with random error terms set to zero, error will be introduced into causal effect estimation through random sampling of different combinations of effect alleles. However, where a causal effect is not present, the effect estimated will consistently be zero regardless of the combinations of alleles sampled, so random error should not be introduced:



\newpage
### Invalid Instruments 
\leavevmode\newline Where invalid instruments are present (i.e. `prop_invalid` $\ne$ `0`) and random error terms are set to 0, graphs of gene-exposure coefficients versus gene-outcome coefficients should be straight lines through the origin and all points representing valid instruments; the invalid instruments should appear as outliers to this line:



\newpage
### Balanced Versus Directional Pleiotropy
\leavevmode\newline Replotting the above with unbalanced pleiotropy present (`balanced_pleio = FALSE`), the invalid instruments should all appear as outliers in the positive direction, i.e. steepening the line of best fit and leading to overestimation of the causal effect: 


<!-- https://pmc.ncbi.nlm.nih.gov/articles/PMC4469799/ -->
<!-- https://mr-dictionary.mrcieu.ac.uk/term/inside/ -->

\newpage
### InSIDE Assumption and Phi
\leavevmode\newline The variable phi represents additional pleiotropic effects of each invalid instrument when the \acr{InSIDE} assumption is not satisfied. The \acr{InSIDE} assumption states that the gene-exposure association is not correlated with the pleiotropic path gene-outcome path of any invalid genetic instruments. This assumption can be violated if e.g.:

- several invalid genetic instruments influence the outcome via the same pleiotropic path

- several invalid genetic instruments are related to the same (unmeasured) confounders of the exposure:outcome relationship, aka correlated pleiotropy. 

As such, when the \acr{InSIDE} assumption is violated, even "strong" instruments (i.e. those with a strong gene-exposure relationship) may not allow accurate estimation of the true causal effect, as pleiotropic effects may scale with instrument strength. If pleiotropic effects are balanced, InSIDE assumption violation may lead to greater imprecision in causal effect estimation; if pleiotropic effects are directional, \acr{InSIDE} assumption violation may lead to bias.

Bowden et al [@bowden_consistent_2016] modeled phi as the pleiotropic effects of unmeasured genetic confounders of the exposure:outcome relationship.  Phi adds additional error to causal effect estimation in scenarios with directional pleiotropic effects (`0 < alpha < 0.2`) and \acr{InSIDE} assumption violation. As such, switching `InSIDE_satisfied` from `TRUE` to `FALSE` should add scatter to the linear association expected when plotting alpha versus gene-outcome coefficients with random error terms set to zero:




\newpage
Setting `InSIDE_satisfied = TRUE` should mean `phi = 0`; `InSIDE_satisfied=FALSE` should result in `phi` $\propto$ gene-outcome coefficient, with scatter only in the positive direction of gene-outcome coefficients given the model also requires directional pleiotropy before `phi` is used:




\newpage
## Summary Table {#appendix-sim-summ}

A function (`get_summary_MR_tib_row`) was written to take models generated from each simulated dataset, estimate causal effect using both weighted median and MR-Hevo methodologies, then output a summary formatted as per Tables 2 & 3 in Bowden et al [@bowden_consistent_2016]:











\newpage

# Appendix: R Packages Used {#appendix-pkg}

## Package Citations

This work was completed using R version 4.4.3 [@base] with the following R packages: acronymsdown v. 0.11.1 [@acronymsdown], bookdown v. 0.43 [@bookdown2016; @bookdown2025], car v. 3.1.3 [@car], cowplot v. 1.1.3 [@cowplot], crayon v. 1.5.3 [@crayon], devtools v. 2.4.5 [@devtools], ggdag v. 0.2.13 [@ggdag], gghighlight v. 0.4.1 [@gghighlight], grateful v. 0.2.12 [@grateful], grid v. 4.4.3 [@grid], here v. 1.0.1 [@here], infer v. 1.0.8 [@infer], kableExtra v. 1.4.0 [@kableExtra], knitr v. 1.50 [@knitr2014; @knitr2015; @knitr2025], matrixStats v. 1.5.0 [@matrixStats], medicaldata v. 0.2.0 [@medicaldata], parallel v. 4.4.3 [@parallel], rmarkdown v. 2.29 [@rmarkdown2018; @rmarkdown2020; @rmarkdown2024], rstan v. 2.32.7 [@rstan], tidyverse v. 2.0.0 [@tidyverse], TwoSampleMR v. 0.6.16 [@TwoSampleMR2017; @TwoSampleMR2018], wordcountaddin v. 0.3.0.9000 [@wordcountaddin].

## Session Information


```
##  setting  value
##  version  R version 4.4.3 (2025-02-28 ucrt)
##  os       Windows 11 x64 (build 26100)
##  system   x86_64, mingw32
##  ui       RTerm
##  language (EN)
##  collate  English_United Kingdom.utf8
##  ctype    English_United Kingdom.utf8
##  tz       Europe/London
##  date     2025-06-08
##  pandoc   3.4 @ C:/Program Files/RStudio/resources/app/bin/quarto/bin/tools/ (via rmarkdown)
##  quarto   NA @ C:\\PROGRA~1\\RStudio\\resources\\app\\bin\\quarto\\bin\\quarto.exe
```

```
## # A tibble: 22 x 5
##    package      ondiskversion loadedversion date       source                   
##    <chr>        <chr>         <chr>         <chr>      <chr>                    
##  1 acronymsdown 0.11.1        0.11.1        2025-06-07 Github (rchaput/acronyms~
##  2 bookdown     0.43          0.43          2025-04-15 CRAN (R 4.4.3)           
##  3 cowplot      1.1.3         1.1.3         2024-01-22 CRAN (R 4.4.3)           
##  4 dplyr        1.1.4         1.1.4         2023-11-17 CRAN (R 4.4.3)           
##  5 forcats      1.0.0         1.0.0         2023-01-29 CRAN (R 4.4.3)           
##  6 gghighlight  0.4.1         0.4.1         2023-12-16 CRAN (R 4.4.3)           
##  7 ggplot2      3.5.2         3.5.2         2025-04-09 CRAN (R 4.4.3)           
##  8 grateful     0.2.12        0.2.12        2025-04-30 CRAN (R 4.4.3)           
##  9 here         1.0.1         1.0.1         2020-12-13 CRAN (R 4.4.3)           
## 10 infer        1.0.8         1.0.8         2025-04-14 CRAN (R 4.4.3)           
## 11 kableExtra   1.4.0         1.4.0         2024-01-24 CRAN (R 4.4.3)           
## 12 lubridate    1.9.4         1.9.4         2024-12-08 CRAN (R 4.4.3)           
## 13 medicaldata  0.2.0         0.2.0         2021-08-16 CRAN (R 4.4.3)           
## 14 purrr        1.0.4         1.0.4         2025-02-05 CRAN (R 4.4.3)           
## 15 readr        2.1.5         2.1.5         2024-01-10 CRAN (R 4.4.3)           
## 16 rstan        2.32.7        2.32.7        2025-03-10 CRAN (R 4.4.3)           
## 17 StanHeaders  2.32.10       2.32.10       2024-07-15 CRAN (R 4.4.3)           
## 18 stringr      1.5.1         1.5.1         2023-11-14 CRAN (R 4.4.3)           
## 19 tibble       3.2.1         3.2.1         2023-03-20 CRAN (R 4.4.3)           
## 20 tidyr        1.3.1         1.3.1         2024-01-24 CRAN (R 4.4.3)           
## 21 tidyverse    2.0.0         2.0.0         2023-02-22 CRAN (R 4.4.3)           
## 22 TwoSampleMR  0.6.16        0.6.16        2025-06-05 https://mrcieu.r-univers~
```


\newpage
