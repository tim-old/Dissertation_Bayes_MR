---
title: "4. Results"
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    dev: cairo_pdf
    fig_caption: TRUE
    number_sections: FALSE
    global_numbering: FALSE
    pandoc_args: !expr acronymsdown::add_filter()
  # pdf_document:
  #   latex_engine: xelatex
  #   dev: cairo_pdf
knit: (function(inputFile, encoding) {
      rmarkdown::render(inputFile,
                        encoding = encoding,
                        knit_root_dir = rprojroot::find_rstudio_root_file(),
                        output_dir = file.path("../Output")
                        )})
bibliography: ../Script/Lit_Rev_Refs.bib
csl: ../Script/vancouver-superscript.csl
link-citations: TRUE
urlcolor: blue  
acronyms:
  loa_title: ""
  include_unused: TRUE
  insert_loa: FALSE
  insert_links: TRUE
  id_prefix: "acronyms_"
  sorting: "alphabetical"
  non_existing: "key"
  style: "long-short"
  fromfile: ./_acronyms.yml
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE, 
                      message = FALSE, 
                      error = FALSE,
                      cache = TRUE, 
                      include = FALSE, 
                      dev = "png", 
                      dpi = 500
)

# Load packages
library(tidyverse)
library(dplyr)
library(bookdown)
library(TwoSampleMR)
library(rstan)
library(here)
library(cowplot)
library(kableExtra)
library(tables)
library(flextable)
library(ftExtra)
library(officer)

# Load University of Edinburgh colour palette
source(here("MSc_Thesis_Split", "Script", "edin_uni_colours.R"))

# Load pre-formatted plot template - call to ggplot with UoE colours
source(here("MSc_Thesis_Split", "Script", "edin_fig_style.R"))

# Load function scripts
source(here("MSc_Thesis_Split", "Script", "simulation_functions.R"))

# Compile model for MR-Hevo
mr.stanmodel <- stan_model(file = here("MSc_Thesis_Split",
                                       "Script",
                                       "Hevo",
                                       "MRHevo_summarystats.stan"),
                           model_name = "MRHevo.summarystats", 
                           verbose = FALSE)


# Load data
## 0% Invalid
no_causal_10k_point0_scen1_models <- readRDS(file = here("MSc_Thesis_Split", "Data", "Simulated_Datasets", "no_causal_10k_point0_scen1_models.rds"))
causal_10k_point0_scen1_models <- readRDS(file = here("MSc_Thesis_Split", "Data", "Simulated_Datasets", "causal_10k_point0_scen1_models.rds"))

## 10% Invalid
no_causal_10k_point1_scen1_models <- readRDS(file = here("MSc_Thesis_Split", "Data", "Simulated_Datasets", "no_causal_10k_point1_scen1_models.rds"))
causal_10k_point1_scen1_models <- readRDS(file = here("MSc_Thesis_Split", "Data", "Simulated_Datasets", "causal_10k_point1_scen1_models.rds"))

## 20% Invalid
no_causal_10k_point2_scen2_models <- readRDS(file = here("MSc_Thesis_Split", "Data", "Simulated_Datasets", "no_causal_10k_point2_scen2_models.rds"))
causal_10k_point2_scen2_models <- readRDS(file = here("MSc_Thesis_Split", "Data", "Simulated_Datasets", "causal_10k_point2_scen2_models.rds"))

## 30% Invalid
no_causal_10k_point3_scen3_models <- readRDS(file = here("MSc_Thesis_Split", "Data", "Simulated_Datasets", "no_causal_10k_point3_scen3_models.rds"))
causal_10k_point3_scen3_models <- readRDS(file = here("MSc_Thesis_Split", "Data", "Simulated_Datasets", "causal_10k_point3_scen3_models.rds"))


# Load results
# No Causal:
no_causal_10k_scen1_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "no_causal_10k_scen1_sim_summ_tib.rds"))
#no_causal_20k_scen1_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "no_causal_20k_scen1_sim_summ_tib.rds"))

no_causal_10k_scen2_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "no_causal_10k_scen2_sim_summ_tib.rds"))
#no_causal_20k_scen2_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "no_causal_20k_scen2_sim_summ_tib.rds"))

#no_causal_10k_scen3_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "no_causal_10k_scen3_sim_summ_tib.rds"))
#no_causal_20k_scen3_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "no_causal_20k_scen3_sim_summ_tib.rds"))


# Causal:
causal_10k_scen1_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "causal_10k_scen1_sim_summ_tib.rds"))
#causal_20k_scen1_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "causal_20k_scen1_sim_summ_tib.rds"))

causal_10k_scen2_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "causal_10k_scen2_sim_summ_tib.rds"))
#causal_20k_scen2_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "causal_20k_scen2_sim_summ_tib.rds"))

causal_10k_scen3_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "causal_10k_scen3_sim_summ_tib.rds"))
#causal_20k_scen3_sim_summ_tib <- readRDS(file = here("MSc_Thesis_Split", "Data", "Summary_Tables", "causal_20k_scen3_sim_summ_tib.rds"))

# Citation Search 

Citations_Instrument_Data <- read.csv(here("MSc_Thesis_Split", "Data", "Citations_Datasets", "Citations_Instrument_Data.csv")) %>% as.tibble() #%>% filter(Instrument !="rs7326482") %>% mutate(N=1)
# Citations_Instrument_Data_2 <- read.csv(here("MSc_Thesis_Split", "Data", "Citations_Datasets", "Citations_Instrument_Data.csv")) %>% as.tibble() #%>%filter(Instrument !="rs7326482") %>%  mutate(N=2)

```

```{r sim-summ-tibs}

# --- No Causal --- #
# Scenario 1
no_causal_scen1_sim_summ_tib <- bind_rows(no_causal_10k_scen1_sim_summ_tib#,
                                          #no_causal_20k_scen1_sim_summ_tib
) %>%
  mutate(Scenario = "Scenario 1: Balanced pleiotropy, InSIDE assumption satisfied")

# Scenario 2
no_causal_scen2_sim_summ_tib <- bind_rows(no_causal_10k_scen2_sim_summ_tib#,
#no_causal_20k_scen2_sim_summ_tib
                                          ) %>%
  mutate(Scenario = "Scenario 2: Directional pleiotropy, InSIDE assumption satisfied")

# Scenario 3
#no_causal_scen3_sim_summ_tib <- bind_rows(no_causal_10k_scen3_sim_summ_tib#,
#                                           no_causal_20k_scen3_sim_summ_tib
#                                           ) %>%
#   mutate(Scenario = "Scenario 3: Directional pleiotropy, InSIDE assumption not satisfied")


# Summary
no_causal_sim_summ_tib <- bind_rows(no_causal_scen1_sim_summ_tib,
                                    no_causal_scen2_sim_summ_tib#,
                                    #no_causal_scen3_sim_summ_tib
)%>% 
  mutate(WME_Lower_CI = WME_Av - 1.96 * WME_SE,
         WME_Upper_CI = WME_Av + 1.96 * WME_SE,
         Pos_Rate_Diff = Hevo_Pos_Rate - WME_Pos_Rate,
         Hevo_Better = Pos_Rate_Diff < 0)


# --- Causal --- #
# Scenario 1
causal_scen1_sim_summ_tib <- bind_rows(causal_10k_scen1_sim_summ_tib#,
                                       #causal_20k_scen1_sim_summ_tib
) %>% 
  mutate(Scenario = "Scenario 1: Balanced pleiotropy, InSIDE assumption satisfied")

# Scenario 2
causal_scen2_sim_summ_tib <- bind_rows(causal_10k_scen2_sim_summ_tib#,
                                       #causal_20k_scen2_sim_summ_tib
) %>% 
  mutate(Scenario = "Scenario 2: Directional pleiotropy, InSIDE assumption satisfied")

# Scenario 3
causal_scen3_sim_summ_tib <- bind_rows(causal_10k_scen3_sim_summ_tib#,
                                       #causal_20k_scen3_sim_summ_tib
) %>% 
  mutate(Scenario = "Scenario 3: Directional pleiotropy, InSIDE assumption not satisfied")


# Summary
causal_sim_summ_tib <- bind_rows(causal_scen1_sim_summ_tib,
                                 causal_scen2_sim_summ_tib,
                                 causal_scen3_sim_summ_tib) %>% 
  mutate(WME_Lower_CI = WME_Av - 1.96 * WME_SE,
         WME_Upper_CI = WME_Av + 1.96 * WME_SE,
         Pos_Rate_Diff = Hevo_Pos_Rate - WME_Pos_Rate,
         Hevo_Better = Pos_Rate_Diff < 0)
  
#no_causal_sim_summ_tib
```


# Results

## Simulation Study

### Data Simulation

Data were successfully simulated as intended. A selection of representative visualisations are presented in Figure \@ref(fig:data-sim-validation). 

### Analysis of Simulated Data

Results of \acr{WME} and MR-Hevo analyses of simulated datasets are summarised in Tables \@ref(tab:no-causal-sim-summ-display) and \@ref(tab:causal-sim-summ-display).

Across all cases where no causal effect was present (Table \@ref(tab:no-causal-sim-summ-display)), the mean rate of reporting a causal effect for MR-Hevo was `r mean(no_causal_sim_summ_tib$Pos_Rate_Diff * 100)`% versus \acr{WME}. Of the `r no_causal_sim_summ_tib$Hevo_Better %>% length()` combinations of scenarios and parameters, MR-Hevo exhibited a favourable false positive rate versus \acr{WME} in `r no_causal_sim_summ_tib$Hevo_Better %>% sum(na.rm = TRUE)`. The mean estimate (95% \acr{CI}) across all cases was `r no_causal_sim_summ_tib$Hevo_Av %>% mean() %>% round(2)` (`r no_causal_sim_summ_tib$Hevo_Lower_CI %>% mean() %>% round(2)` to `r no_causal_sim_summ_tib$Hevo_Upper_CI %>% mean() %>% round(2)`) for MR-Hevo and `r no_causal_sim_summ_tib$WME_Av %>% mean() %>% round(2)` (`r no_causal_sim_summ_tib$WME_Lower_CI %>% mean() %>% round(2)` to `r no_causal_sim_summ_tib$WME_Upper_CI %>% mean() %>% round(2)`) for \acr{WME}.


\newpage


```{r data-sim-validation, include=TRUE, fig.height=7.5}
#| fig.id = "data-sim-validation",
#| fig.cap = "Plots of a representative group of simulated datasets; all simulate genetic instruments from the same index from the same random seed. Left and right columns demonstrate null and positive true causal effects, respectively. The scenario and the proportion of invalid (i.e. pleiotropic) genetic instruments changes with each row. a) 10% of instruments invalid, Scenario 1: balanced pleiotropy introduces noise around the causal effect. b) 20% of instruments invalid, Scenario 2: directional pleiotropy biases towards a positive effect estimate. c) 30% of instruments invalid, Scenario 3: directional pleiotropy and InSIDE assumption violation biases strongly towards a positive effect estimate."

# Get random dataset index
set.seed(1701)
rand_example <- sample(1:1000, 1, replace = FALSE)

# Select random dataset from each scenario
models_list <- list(
  # 0% Invalid
  no_causal_10k_point0_scen1_models[[rand_example]],
  causal_10k_point0_scen1_models[[rand_example]],
  ## 10% Invalid
  no_causal_10k_point1_scen1_models[[rand_example]],
  causal_10k_point1_scen1_models[[rand_example]],
  ## 20% Invalid
  no_causal_10k_point2_scen2_models[[rand_example]],
  causal_10k_point2_scen2_models[[rand_example]],
  ## 30% Invalid
  no_causal_10k_point3_scen3_models[[rand_example]],
  causal_10k_point3_scen3_models[[rand_example]]
)

# Create blank list to receive plots
Gamma_gamma_plots <- as.list(rep(NA, length(models_list)))

# Create plot subtitles
subtitles <- c(
  "0% Invalid",
  "",
  "10% Invalid, Scenario 1",
  "",
  "20% Invalid, Scenario 2",
  "",
  "30% Invalid, Scenario 3",
  ""
)


# Create plots
for(model in 1:length(models_list)){
  
  # Set beta for graph slope
  true_beta <- if_else(model%%2 == 1,
                       true = 0,
                       false = 0.1) 
  
  # Label only left/bottom axes
  y_lab <- if_else(model%%2 == 1,
                   true = "Gene-Outcome\nCoefficient (\U1D26)",
                   false = "") 
  
  x_lab <- case_when(model == length(models_list) - 1 | model == length(models_list) ~ "Gene-Exposure Coefficient (\U03B3)",
                     .default = "") 
  
  # Title Causal/Non-Causal
  causal_title <- case_when(model ==  1 ~ "No Causal Effect",
                            model == 2 ~ "Causal Effect",
                            .default = "") 
  
  # Tag index
  tag_index <- if_else(model%%2 == 1,
                       true = (model+1)/2,
                       false = FALSE) 
  
  # Tag text
  tag_text <- if_else(model%%2 == 1,
                       true = paste0(letters[tag_index], ")"),
                       false = "") 
  
  
  # Plot outline
  Gamma_gamma_plots[[model]] <- models_list[[model]] %>%
    tibble() %>% 
    mutate(Invalid = (alpha != 0)) %>%
    plot_template() +
    aes(x = coeff_G_X,
        y = coeff_G_Y) +
    # Instruments
    geom_point(aes(fill = Invalid),
               pch = 21,
               alpha = 0.75,
               size = 3) +
    # Lines
    geom_abline(colour = edin_uni_blue_hex,
                slope = true_beta,
                intercept = 0,
                size = 1) +
    
    # Add betas
    ## True
    geom_text(label = paste0("True \U03B2 = ", true_beta), #beta
              x = 0.1, # labels with gradient (causal effect estimate)
              y = -0.1,
              size = 3,
              fontface = "italic",
              colour = edin_uni_blue_hex,
              hjust = 0,
              data = . %>% slice_head() # prevent over-printing
    ) +
    # Colours for valid/invalid instruments
    scale_fill_manual(values = c(edin_muted_turquoise_hex, edin_burgundy_hex),
                      labels = c("Valid", "Invalid"),
                      guide = "legend",
                      name = "Instruments") +
    # Labels
    labs(#title = causal_title,
         subtitle = subtitles[model],
         tag = tag_text,
         x = x_lab,
         y = y_lab) +
    theme(legend.position = "none",
          plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm"),
          axis.text = element_text(size = 6), 
          axis.title = element_text(size = 7), 
          subtitle = element_text(size = 6)
          ) +
    xlim(-0.06, 0.2125) +
    ylim(-0.11, 0.25) 
  
}

#Legend
legend <- get_legend(Gamma_gamma_plots[[length(models_list)]] +
                       theme(legend.position = "right")
                     )

plot_two_cols <- plot_grid(plotlist = Gamma_gamma_plots, 
                           rel_widths = c(0.55, 0.45),
                           ncol = 2)


# Plot all
plot_grid(plot_two_cols,
          legend,
          ncol = 2,
          rel_widths = c(1, 0.2))

```


\newpage


\newpage
```{r no-causal-sim-summ-display, echo=FALSE, warning=FALSE, cache=TRUE, include=TRUE, tab.id="no-causal-sim-summ-display", tab.cap="Summary of 1,000 simulated Mendelian randomisation studies per combination of scenario and parameters, all with null causal effect", results='asis'}
#| ft.arraystretch = 0.8


# Display
no_causal_sim_summ_tib_display <- no_causal_sim_summ_tib %>%
  # Change names for cleaner plotting
  mutate(Invalid = paste0((Prop_Invalid * 100), "%"),
         F = round(F_stat, 1),
         R2 = paste0(R2_stat *100, "%"),
         Weighted_Median_Mean_Estimate = WME_Av,
         Weighted_Median_Mean_SE = paste0("(", WME_SE, ")"),
         Weighted_Median_Lower_CI = round(WME_Av - 1.96 * WME_SE, 2),
         Weighted_Median_Upper_CI = round(WME_Av + 1.96 * WME_SE, 2),
         Weighted_Median_95_CI = paste0(Weighted_Median_Lower_CI, " to ", Weighted_Median_Upper_CI),
         Weighted_Median_Causal_Report_Rate = paste0((WME_Pos_Rate * 100), "%"),
         MR_Hevo_Mean_Estimate = Hevo_Av,
         MR_Hevo_Mean_SE = paste0("(", Hevo_SE, ")"),
         MR_Hevo_Lower_CI = round(Hevo_Lower_CI, 2),
         MR_Hevo_Upper_CI = round(Hevo_Upper_CI, 2),
         MR_Hevo_95_CI = paste0(round(Hevo_Lower_CI, 2), " to ", round(Hevo_Upper_CI, 2)),
         MR_Hevo_Causal_Report_Rate = paste0((Hevo_Pos_Rate * 100), "%")) %>%
  # Drop old names
  select(N,
         Invalid,
         F,
         R2,
         Weighted_Median_Mean_Estimate,
         Weighted_Median_Mean_SE,
         Weighted_Median_95_CI,
         Weighted_Median_Causal_Report_Rate,
         MR_Hevo_Mean_Estimate,
         MR_Hevo_Mean_SE,
         MR_Hevo_95_CI,
         MR_Hevo_Causal_Report_Rate,
         Scenario) %>%
  as_grouped_data(groups = c("Scenario")) %>%
  as_flextable(hide_grouplabel = TRUE, col_keys = c("N",
                                                    "Invalid",
                                                    "F",
                                                    "R2",
                                                    "Weighted_Median_Mean_Estimate",
                                                    "Weighted_Median_Mean_SE",
                                                    "Weighted_Median_95_CI", 
                                                    "Weighted_Median_Causal_Report_Rate",
                                                    "blank_col",
                                                    "MR_Hevo_Mean_Estimate",
                                                    "MR_Hevo_Mean_SE",
                                                    "MR_Hevo_95_CI", 
                                                    "MR_Hevo_Causal_Report_Rate",
                                                    "Scenario")) |>
  # To separate WME/MR-Hevo
  width(j = "blank_col", width = 0.2) |>
  empty_blanks() |>
  span_header() |>
  align(part = "all", align = "center") |>
  align(part = "body", j =c(5, 9),  align = "right") |>
  align(part = "body", j =c(6, 10),  align = "left") |>
  # Italicise N and F
  italic(part = "header", i = 1, j = c(1,3) ) |>
  # Fix name of invalid IVs
  compose(part = "header", i = 1:4, j = 2, value = as_paragraph("Invalid IVs")) |>
  # Fix name of 95% CIs
  compose(part = "header", i = 3, j = c(7, 12), value = as_paragraph("Mean")) |>
  compose(part = "header", i = 4, j = c(7, 12), value = as_paragraph("95% CI")) |>
  # Fix split headers
  compose(part = "header", i = 3, j = c(5,10), value = as_paragraph("Mean Estimate")) |>
  compose(part = "header", i = 4, j = c(5:6,10:11), value = as_paragraph("(Mean SE)")) |>
  merge_h(part = "header", i = 4) |>
  # Italicise/superscript R^2
  compose(part = "header", i = 1, j = 4, value = as_paragraph(as_i("R"), as_sup(as_i(as.character(2))))) |>
  
  hline(part = "header", i = 2, j = c(5:8, 10:13), border = fp_border(color = "black", width = 1)) |>
  #footnote(i = c(1,4), j = c(2, 5), part = "header", value = as_paragraph(c("IV: Instrumental Variable", "SE: Standard Error")))
  # Fix dimensions
  autofit() |>
  #line_spacing(space = 0, part = "header") |>
  line_spacing(space = 1, part = "body") |>
  fit_to_width(max_width = 6.5) |>
  height_all(height = 5, unit = "mm",part = "all") |>

  # Add footer
  add_footer_lines("IV: Instumental Variable, SE: Standard Error. Null Causal Effect (\U03B2 = 0)") |>
  fontsize(5, i = 1, j = 1, part = "footer")
# set_caption(caption = "Summary of 1000 Simulated Mendelian Randomisation Studies With Null Causal Effect (\U03B2 = 0)",
#             style = "Table Caption",
#             autonum = run_autonum(seq_id = "tab",
#                                   bkm = "no-causal-sim-summ-tib"))

no_causal_sim_summ_tib_display


```


\newpage
```{r causal-sim-summ-display, echo=FALSE, warning=FALSE, cache=TRUE, include=TRUE, tab.id="causal-sim-summ-display", tab.cap="Summary of 1,000 simulated Mendelian randomisation studies per combination of scenario and parameters, all with positive causal effect", results='asis'}

# Display
causal_sim_summ_tib_display <- causal_sim_summ_tib %>%
  # Change names for cleaner plotting
  mutate(Invalid = Prop_Invalid,
         F = round(F_stat, 1),
         R2 = paste0(R2_stat *100, "%"),
         Weighted_Median_Mean_Estimate = WME_Av,
         Weighted_Median_Mean_SE = paste0("(", WME_SE, ")"),
         Weighted_Median_Positive_Rate = WME_Pos_Rate * 100,
         MR_Hevo_Mean_Estimate = Hevo_Av,
         MR_Hevo_Mean_SE= paste0("(", Hevo_SE, ")"),
         MR_Hevo_Positive_Rate = Hevo_Pos_Rate * 100) %>%
  # Drop old names
  select(N,
         Invalid,
         F,
         R2,
         Weighted_Median_Mean_Estimate,
         Weighted_Median_Mean_SE,
         Weighted_Median_Positive_Rate,
         MR_Hevo_Mean_Estimate,
         MR_Hevo_Mean_SE,
         MR_Hevo_Positive_Rate,
         Scenario) %>%
  as_grouped_data(groups = c("Scenario")) %>%
  as_flextable(hide_grouplabel = TRUE, col_keys = c("N",
                                                    "Invalid",
                                                    "F",
                                                    "R2",
                                                    "Weighted_Median_Mean_Estimate",
                                                    "Weighted_Median_Mean_SE",
                                                    "Weighted_Median_Positive_Rate",
                                                    "blank_col",
                                                    "MR_Hevo_Mean_Estimate",
                                                    "MR_Hevo_Mean_SE",
                                                    "MR_Hevo_Positive_Rate",
                                                    "Scenario")) |>
  # To separate WME/MR-Hevo
  width(j = "blank_col", width = 0.2) |>
  empty_blanks() |>
  span_header() |>
  align(part = "all", align = "center") |>
  align(part = "body", j =c(5, 9),  align = "right") |>
  align(part = "body", j =c(6, 10),  align = "left") |>
  # Italicise N and F
  italic(part = "header", i = 1, j = c(1,3) ) |>
  # Fix name of invalid IVs
  compose(part = "header", i = 1:4, j = 2, value = as_paragraph("Proportion \nof Invalid IVs")) |>
  # Fix split headers
  compose(part = "header", i = 3, j = c(5,9), value = as_paragraph("Mean Estimate")) |>
  compose(part = "header", i = 4, j = c(5:6,9:10), value = as_paragraph("(Mean SE)")) |>
  merge_h(part = "header", i = 4) |>
  # Italicise/superscript R^2
  compose(part = "header", i = 1, j = 4, value = as_paragraph(as_i("R"), as_sup(as_i(as.character(2))))) |>
  
  hline(part = "header", i = 2, j = c(5:7, 9:11), border = fp_border(color = "black", width = 1)) |>
  #footnote(i = c(1,4), j = c(2, 5), part = "header", value = as_paragraph(c("IV: Instrumental Variable", "SE: Standard Error")))
  #add_footer_lines("Mean estimates, meand standar")
  autofit() |>
  fit_to_width(max_width = 7.5) |>
  add_footer_lines("IV: Instumental Variable, SE: Standard Error \nData from 1000 Simulated Mendelian Randomisation Studies \nPositive Causal Effect (\U03B2 = 0.1)")
# set_caption(caption = "Summary of 1000 Simulated Mendelian Randomisation Studies With Null Causal Effect (\U03B2 = 0)",
#             style = "Table Caption",
#             autonum = run_autonum(seq_id = "tab",
#                                   bkm = "no-causal-sim-summ-tib"))

causal_sim_summ_tib_display
#causal_sim_summ_tib


```


```{r citations-reanalysis-summ-tib, include=TRUE, fig.id=TRUE,cache=TRUE, tab.cap=""}

# library(tidyverse)
# library(dplyr)
# library(bookdown)
# library(TwoSampleMR)
# library(rstan)
# library(here)
# library(cowplot)
# library(kableExtra)
# library(tables)
# library(flextable)
# library(ftExtra)
# library(officer)
# 
# # Load function scripts
# source(here("MSc_Thesis_Split", "Script", "simulation_functions.R"))
# source(here("MSc_Thesis_Split", "Script", "Hevo", "functions.mrhevo.R"))
# 
# 
# # # Compile model for MR-Hevo
# mr.stanmodel <- stan_model(file = here("MSc_Thesis_Split",
#                                        "Script",
#                                        "Hevo",
#                                        "MRHevo_summarystats.stan"),
#                            model_name="MRHevo.summarystats",
#                            verbose=FALSE)

#Data_List <- bind_rows(Citations_Instrument_Data, Citations_Instrument_Data_2)


##reanalysis_tib <- get_reanalysis_tib(Citations_Instrument_Data) #%>% mutate(citation = "[@bowden_consistent_2016]") #%>% kable()

##reanalysis_tib #%>% 
#kable()

#str(Data_List)

```

Table (\#tab:citations-reanalysis-summ-tib) reference[@bowden_consistent_2016]



```{r citations-reanalysis-summ-fn, include=FALSE}

get_reanalysis_tib <- function(models_in){
  
  output_tib_row <- tibble(N = as.integer(),
                           WME_Av = as.double(),
                           WME_SE = as.double(),
                           WME_OR = as.double,
                           Hevo_Av = as.double(),
                           Hevo_SE = as.double(),
                           Hevo_OR = as.double()
  )
  
  # Create blank tibble to receive results of Weighted
  # Median Estimator function from MR-Base
  
  results_tib <-  tibble(N = as.integer(),
                         WME_est = as.double(),
                         WME_se = as.double(),
                         WME_pval = as.double(),
                         WME_nsnp = as.integer(),
                         Hevo_est = as.double(),
                         Hevo_se = as.double(),
                         Hevo_sd = as.double(),
                         Hevo_2.5 = as.double(),
                         Hevo_97.5 = as.double(),
                         Hevo_causal_detected = as.logical()
  )
  
  # Convert full tibble to list of 1 tibble per dataset
  model_list <- models_in %>% 
    group_by(N) %>%
    group_split()
  
  
  # Should = 10
  n_datasets <- length(model_list)
  
  # Run WME and MR-Hevo for each dataset 
  for(dataset in 1:n_datasets){
    
    # Stored as individual vectors for MR-Hevo/RStan - not
    # Tidyverse compatible
    coeff_G_X_vect <- model_list[[dataset]]$Coeff_G_X
    coeff_G_Y_vect <- model_list[[dataset]]$Coeff_G_Y
    coeff_G_X_SE_vect <- model_list[[dataset]]$Coeff_G_X_SE
    coeff_G_Y_SE_vect <- model_list[[dataset]]$Coeff_G_Y_SE
    
    
    # N.B. MR-Hevo terminology vs WME paper/other code:
    # alpha = effects of instruments on exposure, i.e. coeff_G_X
    # beta = pleiotropic effects of instruments on outcome, i.e. alpha in WME
    # gamma = effects of instruments on outcome, i.e. coeff_G_Y
    # theta = causal effect X on Y, i.e. b
    
    # Results from weighted median estimator method
    WME_results <- mr_weighted_median(b_exp = coeff_G_X_vect,
                                      b_out = coeff_G_Y_vect,
                                      se_exp = coeff_G_X_SE_vect,
                                      se_out = coeff_G_Y_SE_vect,
                                      parameters = list(nboot = 1000))
    
    # Results from MR-Hevo method
    Hevo_results<- run_mrhevo.sstats(alpha_hat = coeff_G_X_vect,
                                     se.alpha_hat = coeff_G_X_SE_vect,
                                     gamma_hat = coeff_G_Y_vect,
                                     se.gamma_hat = coeff_G_Y_SE_vect
    ) %>%
      summary()
    
    
    # Extract WME Results
    results_tib[dataset, ]$WME_est <- WME_results$b
    results_tib[dataset, ]$WME_se <- WME_results$se
    results_tib[dataset, ]$WME_pval <- WME_results$pval
    results_tib[dataset, ]$WME_nsnp <- WME_results$nsnp
    
    # Extract MR-Hevo Results
    results_tib[dataset, ]$Hevo_est <- Hevo_results$summary["theta","mean"]
    results_tib[dataset, ]$Hevo_se <- Hevo_results$summary["theta","se_mean"]
    results_tib[dataset, ]$Hevo_sd <- Hevo_results$summary["theta","sd"]
    results_tib[dataset, ]$Hevo_2.5 <- Hevo_results$summary["theta","2.5%"]
    results_tib[dataset, ]$Hevo_97.5 <- Hevo_results$summary["theta","97.5%"]
    
    results_tib[dataset, ]$N <- dataset
    
  }
  
  results_tib <- results_tib %>%
    mutate(Hevo_causal_detected = !(Hevo_2.5 < 0  & Hevo_97.5 > 0))
  
  
  # https://pmc.ncbi.nlm.nih.gov/articles/PMC10616660/
  # https://mr-dictionary.mrcieu.ac.uk/term/r-squared/
  output_tib_row <- results_tib %>%
    summarise(N = N,
              WME_Av = mean(WME_est),
              WME_SE = mean(WME_se),
              WME_OR = exp(WME_Av),
              Hevo_Av = mean(Hevo_est),
              Hevo_SE = mean(Hevo_se),
              Hevo_Causal = Hevo_causal_detected
    ) %>%
    mutate(across(where(is.double), round, 3))
  
  return(output_tib_row)
  #return(results_tib)
  
  
}


```

Word count: `r wordcountaddin::word_count(here::here("MSc_Thesis_Split", "Script", "4_Results.Rmd"))`

